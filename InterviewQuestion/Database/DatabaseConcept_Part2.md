# 📖 Database Essential Concept Part2
- 주제: 
- ⏳ 최초 생성: 19. 09. 21
- ⌛ 마지막 작업: 19. 09. 21


## 📋 트랜잭션
### 트랜잭션이란?
- 트랜잭션은 하나의 작업을 수행하기 위해 필요한 데이터베이스의 연산을 모아놓은 것으로 데이터베이스의 논리적인 작업의 단위가 된다. 
- 일반적으로 데이터베이스 연산은 SQL 문으로 표현되므로 트랜잭션을 작업에 필요한 SQL문의 모임으로 이애해도 된다. 

### 트랜잭션이 특성
>ACID(원자성, 일관성, 고립성, 지속성)는 데이터베이스 트랜잭션이 안전하게 수행된다는 것을 보장하기 위한 성질을 가리키는 약어이다.(Wiki ACID란?)
- 트랜잭션이 성공적으로 처리되어 데이터베이스의 무결성과 일관성을 보장라려면 4가지 특성이 있어야합니다.
- 트랜잭션의 네 가지 특성을 영단어 첫 자를 따서 ACID특성이라고 합니다. 
- **원자성(Atomicity)**
    + 트랜잭션은 분해가 불가능한 최소의 단위인 하나의 원자처럼 동작한다는 의미입니다.
    + 예. 티스토리 게시판에 글을 작성해서 저장 버튼을 누릅니다. 티스토리의 데이터 베이스에 성공적으로 저장되거나, 실패하거나 두 가지 경우밖에 없다는 것이다. 글 내용의 절반만 저장되고 나머지는 저장 안되는 경우가 존재하지 않는다는 것을 보장한다는 것입니다.  

- **일관성(Consistency)**
    + 트랜잭션 작업이 시작되기 전에 데이터베이스 상태가 일관된 상태였다면 트랜잭션 작업이 종료된 후에도 일관성 있는 데이터 베이스 상태를 유지해야 합니다.
    + 예. 티스토리 게시판에 글을 쓰는데 제목의 글자 제한이 255자라고 하자. 트랜잭션이 일어나면 이러한 조건을 만족해야 하는 것이다. 만약 이를 위반하는 트랜잭션이 있다면 거부해야 합니다. 
    + 예. 은행 데이터베이스에 A와 B 두 사람의 데이터만 있다고 합시다. A는 10,000원 B는 0원이 계좌에 있습니다. A가 B에게 5000원을 송금하는 트랜잭션이 일어나면 A와 B의 계좌 잔액은 5000으로 총 계좌 잔액이 10000입니다. 따라서 송금 전과 후의 전체 총액이 10000으로 일관성 있는 상태를 유지고 있습니다. 
- **고립성(Isolation)**
    + 트랜잭션 작업 수행 중에는 다른 트랜잭션에 영향을 주어서도 안되고, 다른 트랜잭션들에 의해 간섭을 받아서도 안 된다는 것을 의미합니다. 
    + 다른 트랜잭션의 영향을 받게 되면 영향을 주는 트랜잭션에 의해 자신의 동작이 달라 질 수 있기 때문에 하나의 트랜잭션은 고립된 상태에서 수행되어야 한다는 것을 의미.
    + 예. 자유게시판에 A, B 두 사람이 글을 동시에 업로드 한다고 하면, 두 트랜젝션에 충돌이 일어나서 A가 작성한 제목이 저장되고 B가 작성한 내용이 저장되는게 아니라 A의 트랜잭션이 종료되기 전까지 B의 트랜잭션은 실행되지 않고 대기하는 것을 말합니다.


- **지속성(Durablility)**
    + 일련의 데이터 조작(트랜잭션 조작)을 완료하고 완료 통지를 사용자가 받는 시점에서 그 조작이 영구적이 되어 그 결과를 잃지 않는 것을 나타낸다. 시스템이 정상이거나  데이터베이스나 운영체제의 이상 종료 혹은 다양한 시스템 장애를 견딜 수 있다는 것을 말한다. 
    + MySQL을 포함해 많은 데이터베이스의 구현에서는 트랜젝션 조작을 하드 디스크에 로그로 기록하고 시스템에 이상이 발생하면 그 로그를 사용해 이상 발생 전까지 복원하는 것으로 지속성을 실현하고 있다. 

### 트랜잭션의 연산
- **commit 연산**
    + 트랜잭션이 성공적으로 수행되었음을 선언(작업 완료)
- **rollback 연산**
    + 트랜잭션이 수행을 실패했음을 선언(작업 취소)

### 트랜잭션의 상태
![transaction_state](https://github.com/KoEonYack/LevelUp-Algorithm/blob/master/InterviewQuestion/Database/img/transaction_state.jpg?raw=true)
- **활동 상태 :** 트랜잭션이 수행을 시작하여 현재 수행 중인 상태.
- **부분 완료 상태:** 트랜잭션의 마지막 연산이 실행된 직후의 상태. 이작은 트랜잭션 수행이 성공적으로 완료됬다고 할 수 없습니다.
- **완료 상태:** 트랜잭션이 성공적으로 완료되어 commit 연산을 실행한 상태. 트랜잭션이 완료 상태가 되면 트랜잭션이 수행한 최종 결과를 데이터베이스에 반영합니다.
- **실패 상태:** 하드웨어, 소프트웨어 혹은 트랜잭션 내부 오류로 인해 장애가 발생하여 트랜잭션의 수행이 중단된 상태.
- **철회 상태:** 트랜잭션의 수행이 실패하여 rollback 연산을 실행한 상태.

## 📋 장애와 회복
- 데이터베이스 시스템은 사용자의 실수, 정전 등으로 인한 하드웨어 고장, 소프트웨어의 논리적 오류 등 다양한 원인에 의해서 **장애**가 발생할 수 있습니다. 트랜잭션을 보장하고, 데이터베이스를 모순이 없는 일관된 상태로 유지하기 위해서 데이터베이스 관리 시스템은 **회복 기능**을 제공합니다. 

### 장애의 유형
- **트랜잭션 장애**
    + 의미: 트랜잭션 수행 중 오류가 발생하여 정상적으로 수행을 계속 할 수 없는 상태
    + 원인: 트랜잭션의 논리적 오류, 잘못된 데이터 입력, 시스템 자원의 과다 사용 요구, 처리 대상 데이터의 부재 등

- **시스템 장애**
    + 의미: 하드웨어의 결함으로 정상적으로 수행을 계속 할 수 없는 상태
    + 원인: 하드웨어 이상으로 메인 메모리에 저장된 정보가 손실되거나 교착 상태가 발생한 경우 등

- **미디어 장애**
    + 의미: 디스크 장치의 결함으로 디스크에 저장된 데이터베이스 일부 혹은 전체가 손상된 상태
    + 원인: 디스크 헤드의 손상이나 고장 등

### 회복 기법 - 회복을 위해 복사본을 만드는 방법
- **덤프**: 데이터베이스 전체를 다른 저장 장치에 주기적으로 복사하는 방법
- **로그**: 데이터베이스에서 변경 연산이 실행될 때마다 데이터를 변경하기 이전 값과 변경한 이후의 값을 별도의 파일에 기록하는 방법

### 회복 기법 - 회복 연산
- **redo(재실행)**: 가장 최근에 저장한 데이터베이스 복사본을 가져온 후 로그를 이용해 복사본이 만들어진 이후에 실행된 모든 변경 연산을 재실행하여 장애가 발생하기 직전의 데이터베이스 상태로 복구(전반적으로 손상된 경우에 주로 사용)
- **undo(취소)**: 로그를 이용해 지금까지 실행된 모든 변경 연산을 취소하여 데이터베이스를 원래의 상태로 복구(변경 중이거나 이미 변경된 내용의 신뢰성을 잃은 경우에 주로 사용)

### 데이터베이스 회복 기법 분류
- 로그 회복 기법
    + 즉시 갱신 회복 기법: 트랜잭션 수행 중에 데이터를 변경한 연산의 겨로가를 데이터베이스에 즉시 반영한다.  
    + 지연 갱신 회복 기법: 트랜잭션이 수행되는 도중 데이터 변경 연산의 결과를 데이터베이스에 즉시 반영하지 않고 로그 파일에만 기록해두었다가, 트랜잭션이 부분 완려된 후에 로그에 기록된 내용을 이용해 데이터베이스에 한번에 반영합니다. 
- 검사 시점 회복 기법: 로그 전체를 분석하여 로그에 기록되어 있는 모든 트랜잭션을 대상으로 redo나 undo중에서 적용할 회복 연산을 결정해야합니다. 그러나 로그 전체를 대상으로 회복 기법을 적용하면 데이터베이스 회복에 많은 시간이 걸리고 redo 연산을 수행할 필요가 없는 트랜잭션에도 redo 연산을 실행하는 일이 발생하기도 합니다. 검사 시점 회복 기법은 로그 회복 기법과 같은 방법으로 로그 기록을 이용하되, 일정 시간 간격으로 검사 시점을 만들어줍니다. 그리고 장애가발생하면 가장 최근 검사 시점 이전의 트랜잭션에는 회복 작업을 수행하지 않고, 이후의 트랜잭션에만 회복 작업을 수행합니다. 이는 불필요한 회복 작업을 수행하지 않아 데이터베이스 회복 시간이 단축되는 장점이 있습니다. 
- 미디어 회복 기법: 전체 데이터베이스의 내용을 일정 주기마다 다른 안전한 저장 장치에 복사해두는 덤프를 말합니다. 전체 데이터베이스를 다른 저장 장치에 복사하는 것은 비용이 많이 들고 복사하는 동안에 트랜잭션 수행을 중단해야 하므로 CPU가 낭비됩니다. 



### Reference
+ [데이터베이스 개론 : 기초 개념부터 빅 데이터까지 큰 흐름이 보이는 데이터베이스 교과서 (한빛출판사, 김연희 저)](https://terms.naver.com/list.nhn?cid=58430&categoryId=58430)
+ [Github ChangYeop-Yang/Study-DataBase](https://github.com/ChangYeop-Yang/Study-DataBase)
+ 데이터베이스 첫 걸음